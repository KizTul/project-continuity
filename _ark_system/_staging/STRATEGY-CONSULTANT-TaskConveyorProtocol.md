# Контекстная Капсула: Внедрение Протокола "Конвейер Задач"
**"Обоснование (Ссылка на Опыт):** Данная задача является прямым следствием и системным решением критического сбоя, задокументированного в `ARK_EXPERIENCE_CODEX.json` как **`EXP-0042: Парадокс Актуальности Капсулы`**. Перед началом работы обязательно изучить этот "Атом Опыта" для полного понимания проблемы."

**Источник:** Рекомендации внешнего архитектурного аудита от 29.08.2025.

**Цель:** Заменить существующий, ненадежный протокол асинхронной передачи задач на полноценную, отказоустойчивую систему управления задачами ("Конвейер Задач"), которая системно устраняет "Парадокс Актуальности Капсулы".

---

## 1. Ключевые Компоненты Архитектуры

1.  **`_ark_system/_staging/queue.json` (Реестр Задач):**
    *   **Назначение:** Единственный, машиночитаемый источник правды о состоянии всех асинхронных задач. Заменяет ручное сканирование папок.

2.  **`.meta.json` (Метаданные Капсулы):**
    *   **Назначение:** Каждая капсула сопровождается файлом метаданных (ID задачи, контрольная сумма), превращая ее в верифицируемый объект.

3.  **Папки-Состояния:**
    *   `_staging/new/`: Для новых задач.
    *   `_staging/processing/`: Для задач, "захваченных" ИИ.
    *   `_staging/archive/`: Для успешно выполненных задач.
    *   `_staging/failed/`: Для проваленных задач.

## 2. Жизненный Цикл Задачи

1.  **Регистрация:** Задача (капсула + мета) помещается в `new/`, запись добавляется в `queue.json`.
2.  **"Захват" (Claim):** ИИ атомарно меняет статус в `queue.json` и перемещает капсулу в `processing/`.
3.  **Выполнение:** После валидации и бэкапа, запускается `apply_modifications.py`.
4.  **Финализация:** В зависимости от результата, статус в `queue.json` обновляется, а капсула перемещается в `archive/` или `failed/`.

## 3. Принцип Атомарности

Ключевое улучшение: обновление `roadmap.md` (например, отметка чекбокса) **должно быть частью того же "Пакета Модификаций"**, что и основные изменения. Это связывает выполнение задачи, обновление ее статуса и очистку артефактов в единую неразрывную транзакцию.

## 4. План Реализации (Высокоуровневый)

1.  Разработать JSON Schema для `queue.json` и `.meta.json`.
2.  Создать утилиты для регистрации и "захвата" задач.
3.  Модифицировать `apply_modifications.py` для поддержки нового жизненного цикла (включая архивацию вместо удаления).
4.  Реализовать механизм резервного копирования для каждой транзакции.
5.  Интегрировать новый протокол в базовый рабочий цикл ИИ.